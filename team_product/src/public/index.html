<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Base CRUD App</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <!-- ヘッダー -->
      <header>
        <h1>いとうゆうきのタスク管理</h1>
        <p class="subtitle">シンプルなリストアプリ</p>
      </header>

      <!-- アイテム追加フォーム -->
      <section class="add-form">
        <input
          type="text"
          id="titleInput"
          placeholder="新しいアイテムを入力..."
          autocomplete="off"
        />
        <button id="addButton">追加</button>
      </section>

      <!-- アイテム一覧 -->
      <section class="items-container">
        <h2>アイテム一覧</h2>
        <ul id="itemList">
          <!-- ここにアイテムが動的に表示される -->
        </ul>
        <p id="emptyMessage" class="empty-message">
          アイテムがありません。上のフォームから追加してください。
        </p>
      </section>
    </div>

    <script>
      /**
       * Base CRUD App - クライアント側JavaScript
       *
       * このコードはブラウザ上で動作します。
       * ログはブラウザのF12（開発者ツール）に表示されます。
       */

      // =====================================================
      // DOM要素の取得
      // =====================================================
      const titleInput = document.getElementById("titleInput");
      const addButton = document.getElementById("addButton");
      const itemList = document.getElementById("itemList");
      const emptyMessage = document.getElementById("emptyMessage");

      // ページ読み込み時にログ出力
      console.log("[CLIENT] ページが読み込まれました");

      // =====================================================
      // API呼び出し関数
      // =====================================================

      /**
       * アイテム一覧を取得して表示
       *
       * IPO:
       * - Input: なし
       * - Process: サーバーからアイテム一覧を取得
       * - Output: 画面にアイテムを表示
       */
      async function loadItems() {
        console.log("[CLIENT] アイテム一覧を取得中...");

        try {
          // サーバーにリクエスト（この時点でServer層に処理が移る）
          const response = await fetch("/api/items");
          const items = await response.json();

          console.log("[CLIENT] 取得完了:", items.length, "件");

          // 画面を更新
          renderItems(items);
        } catch (error) {
          console.error("[CLIENT] エラー:", error);
          alert("アイテムの取得に失敗しました");
        }
      }

      /**
       * アイテムを追加
       *
       * IPO:
       * - Input: テキストボックスのタイトル
       * - Process: サーバーにPOSTリクエスト → DB保存
       * - Output: 一覧を再読み込み
       */
      async function addItem() {
        const title = titleInput.value.trim();

        // 入力チェック（Client側のバリデーション）
        if (!title) {
          alert("タイトルを入力してください");
          return;
        }

        console.log("[CLIENT] アイテムを追加:", title);

        try {
          // サーバーにPOSTリクエスト
          const response = await fetch("/api/items", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ title }),
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error);
          }

          // 入力欄をクリア
          titleInput.value = "";

          // 一覧を再読み込み
          await loadItems();

          console.log("[CLIENT] 追加完了");
        } catch (error) {
          console.error("[CLIENT] エラー:", error);
          alert("追加に失敗しました: " + error.message);
        }
      }

      /**
       * アイテムを削除
       *
       * IPO:
       * - Input: 削除ボタンクリック（アイテムID）
       * - Process: サーバーにDELETEリクエスト → DB削除
       * - Output: 一覧を再読み込み
       */
      async function deleteItem(id) {
        // 確認ダイアログ
        if (!confirm("本当に削除しますか？")) {
          return;
        }

        console.log("[CLIENT] アイテムを削除: ID =", id);

        try {
          // サーバーにDELETEリクエスト
          const response = await fetch(`/api/items/${id}`, {
            method: "DELETE",
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error);
          }

          // 一覧を再読み込み
          await loadItems();

          console.log("[CLIENT] 削除完了");
        } catch (error) {
          console.error("[CLIENT] エラー:", error);
          alert("削除に失敗しました: " + error.message);
        }
      }

      // =====================================================
      // 画面描画関数
      // =====================================================

      /**
       * アイテム一覧を画面に描画
       */
      function renderItems(items) {
        // リストをクリア
        itemList.innerHTML = "";

        // 空メッセージの表示/非表示
        emptyMessage.style.display = items.length === 0 ? "block" : "none";

        // 各アイテムを描画
        items.forEach((item) => {
          const li = document.createElement("li");
          li.className = "item";
          li.innerHTML = `
          <span class="item-title">${escapeHtml(item.title)}</span>
          <button class="delete-button" onclick="deleteItem(${item.id})">削除</button>
        `;
          itemList.appendChild(li);
        });
      }

      /**
       * HTMLエスケープ（XSS対策）
       */
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // =====================================================
      // イベントリスナー
      // =====================================================

      // 追加ボタンクリック
      addButton.addEventListener("click", addItem);

      // Enterキーで追加
      titleInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          addItem();
        }
      });

      // =====================================================
      // 初期化
      // =====================================================

      // ページ読み込み時にアイテム一覧を取得
      loadItems();
    </script>
  </body>
</html>
